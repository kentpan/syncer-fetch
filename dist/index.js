!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.$syncer=t()}("undefined"!=typeof self?self:window,function(){"use strict";class e{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;this.maxConcurrency=e,this.running=0,this.queue=[]}async add(e){return new Promise((t,r)=>{this.queue.push({task:e,resolve:t,reject:r}),this.process()})}async process(){if(this.running>=this.maxConcurrency||0===this.queue.length)return;this.running++;const{task:e,resolve:t,reject:r}=this.queue.shift();try{t(await e())}catch(e){r(e)}finally{this.running--,this.process()}}}const t=new class{constructor(){this.defaultOptions={timeout:15e3,retries:3,retryDelay:1e3}}createController(){return new AbortController}detectFileType(e,t){if(e){if(e.startsWith("image/"))return"image";if(e.startsWith("text/"))return"text"}return"blob"}toBase64(e){(""===e||e.type&&0===e.size)&&(e="\n");let t=!1;return e.type?(e.type.startsWith("image/")?(console.log(`检测到图片格式: ${e.type}`),t=!0):console.log(`其他文件格式: ${e.type||"未知"}`),new Promise((r,s)=>{const o=new FileReader;o.onloadend=()=>r(o.result.replace(/^data:.+;base64,/,"")),o.onerror=e=>s(t?"图片转换失败:"+e:e),o.readAsDataURL(e)})):Promise.resolve(this.txtToBase64(e))}base64ToString(e){const t=atob(e),r=t.length,s=new Uint8Array(r);for(let e=0;e<r;e++)s[e]=t.charCodeAt(e);return new TextDecoder("utf-8").decode(s)}async blobToString(e){let t=e instanceof Blob&&/json$/i.test(e.type);return new Promise((r,s)=>{const o=new FileReader;o.onloadend=()=>{let e=o.result.replace(/^data:.+;base64,/,"");if(console.log("result:",e),e=this.base64ToString(e),t){let t=e;try{t=JSON.parse(e)}catch{}r(t)}else r(e)},o.readAsDataURL(e)})}txtToBase64(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const t=new TextEncoder("utf-8").encode(e),r=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(r)}async handleResponse(e){const t=e.headers.get("content-type")||"",r=e.url,s=this.detectFileType(t,r);return{data:await e.blob(),fileType:s,contentType:t,size:e.headers.get("content-length")||0}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r={...this.defaultOptions,...t},s=r.signal||this.createController();let o={url:e,code:null,msg:"",data:null,loaded:0,total:0,duration:0};const n=Date.now();let a=null;try{r.before&&await r.before(e,r),r.platform&&(o.platform=r.platform,delete r.platform),r.timeout>0&&(a=setTimeout(()=>{s.abort()},r.timeout)),console.log("fetch:",e,r);const t=await fetch(e,{method:"GET",...r,signal:s.signal});switch(o.code=t.status,t.status){case 200:case 201:case 204:o.msg="ok";break;case 429:o.msg="请求频率超限，请稍后重试";break;case 401:o.msg="未授权，请检查认证信息";break;case 403:o.msg="禁止访问";break;case 404:o.msg="资源未找到";break;case 500:o.msg="服务器内部错误";break;default:o.msg=`请求失败: ${t.statusText}`}const n=await this.handleResponse(t,r);o.data=n.data,o.fileType=n.fileType,o.contentType=n.contentType,o.size=n.size}catch(e){"AbortError"===e.name?(o.code=0,o.msg="请求已取消"):(o.code=e.code||-1,o.msg=e.message||"网络错误")}finally{a&&clearTimeout(a),o.duration=Date.now()-n,r.after&&await r.after(e,o)}return o}async requestWithProxy(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{proxies:r,...s}=t;if(!r||!Array.isArray(r)||0===r.length)return await this.request(e,s);let o=null;for(const t of r)try{const r={timeout:5e3,...s};let n;if("string"==typeof t)n=`${t}${e}`;else if(t.perfix)n=`${t.url}${e}`;else{const r=new URL(e),s=r.pathname+r.search+r.hash;n=`${t.url}${s}`}const a=await this.request(n,r);if(a.code>=200&&a.code<300)return a;o=a}catch(e){o={code:-1,msg:e.message,url:t.url}}return o||{code:-1,msg:"所有代理请求失败",url:e}}async downloadConcurrent(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s=r.maxConcurrency||3,o=new e(s),n=t.map(e=>()=>this.requestWithProxy(e,r)).map(e=>o.add(e));return await Promise.allSettled(n)}async uploadParallel(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=t.map(async t=>{try{if(e&&"object"==typeof e){const s={...e,...t.branch&&{branch:t.branch},...t.sha&&{sha:t.sha}};r.body=JSON.stringify(s),r.headers={"Content-Type":"application/json",...t.headers}}else r.body=e;r.method=r.method||t.method||"POST";const s=await this.request(t.url,r);return{platform:t.name,...s}}catch(e){return{platform:t.name,code:-1,msg:e.message}}});return await Promise.allSettled(s)}},r=async(e,r)=>await t.request(e,r);return r.request=(e,r)=>t.request(e,r),r.proxy=(e,r)=>t.requestWithProxy(e,r),r.downloadAll=(e,r)=>t.downloadConcurrent(e,r),r.uploads=(e,r,s)=>t.uploadParallel(e,r,s),r.Aborter=()=>t.createController(),r.fileType=(e,r)=>t.detectFileType(e,r),r.toBase64=e=>t.toBase64(e),r.blobToString=e=>t.blobToString(e),r});
